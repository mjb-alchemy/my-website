---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const illustrations = await getCollection('illustrations');
const sortedIllustrations = illustrations.sort((a, b) =>
  b.data.date.valueOf() - a.data.date.valueOf()
);
---

<BaseLayout title="Illustrations">
  <!-- Header - Bold -->
  <header class="pt-16 pb-20 max-w-4xl">
    <span class="text-sm font-medium tracking-widest uppercase text-text-muted mb-6 block">Selected Work</span>
    <h1 class="mb-8">Illustrations</h1>
    <p class="text-xl text-text-muted max-w-2xl leading-relaxed">
      Sketches, studies, and finished pieces. A collection of visual work exploring form, color, and narrative.
    </p>
  </header>

  {sortedIllustrations.length === 0 ? (
    <div class="py-24 text-center">
      <p class="text-text-muted mb-2">No illustrations yet.</p>
      <p class="text-sm text-text-light">
        Add your first illustration through the CMS at <code class="bg-bg-alt px-2 py-1">/admin</code>
      </p>
    </div>
  ) : (
    <div class="gallery-grid pb-16">
      {sortedIllustrations.map((illustration, index) => (
        <article
          class="gallery-item cursor-pointer group"
          data-lightbox
          data-title={illustration.data.title}
          data-description={illustration.data.description || ''}
          data-date={illustration.data.date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long'
          })}
        >
          <div class="overflow-hidden mb-4">
            <img
              src={typeof illustration.data.image === 'string'
                ? illustration.data.image
                : illustration.data.image.src}
              alt={illustration.data.title}
              class="img-editorial group-hover:scale-[1.02] transition-transform duration-500"
              loading="lazy"
            />
          </div>
          <h3 class="text-lg mb-1">{illustration.data.title}</h3>
          <p class="text-label">
            {illustration.data.date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short'
            })}
          </p>
        </article>
      ))}
    </div>
  )}

  <!-- Lightbox Modal -->
  <div
    id="lightbox"
    class="fixed inset-0 z-50 hidden bg-text/95 backdrop-blur-sm"
    role="dialog"
    aria-modal="true"
  >
    <button
      id="lightbox-close"
      class="absolute top-6 right-6 text-bg hover:opacity-60 transition-opacity p-2"
      aria-label="Close"
    >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M18 6L6 18M6 6l12 12"/>
      </svg>
    </button>

    <div class="h-full flex flex-col md:flex-row items-center justify-center p-8 md:p-16 gap-8">
      <div class="flex-1 flex items-center justify-center max-h-[70vh] md:max-h-full">
        <img
          id="lightbox-image"
          src=""
          alt=""
          class="max-w-full max-h-full object-contain"
        />
      </div>
      <div class="md:w-80 text-bg">
        <h2 id="lightbox-title" class="text-2xl mb-2"></h2>
        <p id="lightbox-date" class="text-label text-bg/60 mb-4"></p>
        <p id="lightbox-description" class="text-sm text-bg/80"></p>
      </div>
    </div>
  </div>

  <script>
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
    const lightboxTitle = document.getElementById('lightbox-title');
    const lightboxDate = document.getElementById('lightbox-date');
    const lightboxDescription = document.getElementById('lightbox-description');
    const lightboxClose = document.getElementById('lightbox-close');

    document.querySelectorAll('[data-lightbox]').forEach((el) => {
      el.addEventListener('click', () => {
        const img = el.querySelector('img') as HTMLImageElement;
        if (img && lightbox && lightboxImage && lightboxTitle && lightboxDate && lightboxDescription) {
          lightboxImage.src = img.src;
          lightboxImage.alt = img.alt;
          lightboxTitle.textContent = el.getAttribute('data-title') || '';
          lightboxDate.textContent = el.getAttribute('data-date') || '';
          lightboxDescription.textContent = el.getAttribute('data-description') || '';
          lightbox.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      });
    });

    function closeLightbox() {
      if (lightbox) {
        lightbox.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    lightboxClose?.addEventListener('click', closeLightbox);
    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) closeLightbox();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
    });
  </script>
</BaseLayout>
