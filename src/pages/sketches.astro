---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { Image } from 'astro:assets';

const illustrations = await getCollection('illustrations');
const sortedIllustrations = illustrations.sort((a, b) =>
  b.data.date.valueOf() - a.data.date.valueOf()
);
---

<BaseLayout title="Sketches">

  {sortedIllustrations.length === 0 ? (
    <div class="py-24 text-center">
      <p class="text-text-muted mb-2">No illustrations yet.</p>
      <p class="text-sm text-text-light">
        Add your first illustration through the CMS at <code class="bg-bg-alt px-2 py-1">/admin</code>
      </p>
    </div>
  ) : (
    <div class="gallery-grid pb-16">
      {sortedIllustrations.map((illustration, index) => (
        <article
          class="gallery-item cursor-pointer group"
          data-lightbox
          data-title={illustration.data.title}
          data-description={illustration.data.description || ''}
          data-date={illustration.data.date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long'
          })}
        >
          <div class="overflow-hidden">
            {typeof illustration.data.image === 'string' ? (
              <img
                src={illustration.data.image}
                alt={illustration.data.title}
                class="w-full h-auto group-hover:scale-[1.02] transition-transform duration-500"
                loading="lazy"
              />
            ) : (
              <Image
                src={illustration.data.image}
                alt={illustration.data.title}
                width={600}
                class="w-full h-auto group-hover:scale-[1.02] transition-transform duration-500"
              />
            )}
          </div>
        </article>
      ))}
    </div>
  )}

  <!-- Lightbox Modal -->
  <div
    id="lightbox"
    class="fixed inset-0 z-50 hidden bg-text/95 backdrop-blur-sm"
    role="dialog"
    aria-modal="true"
  >
    <button
      id="lightbox-close"
      class="absolute top-4 right-4 md:top-6 md:right-6 text-bg hover:opacity-60 transition-opacity p-2 z-10"
      aria-label="Close"
    >
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path d="M18 6L6 18M6 6l12 12"/>
      </svg>
    </button>

    <div class="h-full flex flex-col md:flex-row items-center justify-center p-4 md:p-8 lg:p-16 gap-4 md:gap-8 overflow-y-auto">
      <div class="flex-1 flex items-center justify-center max-h-[50vh] md:max-h-[80vh] w-full">
        <img
          id="lightbox-image"
          src=""
          alt=""
          class="max-w-full max-h-full object-contain"
        />
      </div>
      <div class="w-full md:w-80 text-bg text-center md:text-left pb-4 md:pb-0">
        <h2 id="lightbox-title" class="text-xl md:text-2xl mb-1 md:mb-2"></h2>
        <p id="lightbox-date" class="text-label text-bg/60 mb-2 md:mb-4"></p>
        <p id="lightbox-description" class="text-sm text-bg/80"></p>
      </div>
    </div>
  </div>

  <script>
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
    const lightboxTitle = document.getElementById('lightbox-title');
    const lightboxDate = document.getElementById('lightbox-date');
    const lightboxDescription = document.getElementById('lightbox-description');
    const lightboxClose = document.getElementById('lightbox-close');

    document.querySelectorAll('[data-lightbox]').forEach((el) => {
      el.addEventListener('click', () => {
        const img = el.querySelector('img') as HTMLImageElement;
        if (img && lightbox && lightboxImage && lightboxTitle && lightboxDate && lightboxDescription) {
          lightboxImage.src = img.src;
          lightboxImage.alt = img.alt;
          lightboxTitle.textContent = el.getAttribute('data-title') || '';
          lightboxDate.textContent = el.getAttribute('data-date') || '';
          lightboxDescription.textContent = el.getAttribute('data-description') || '';
          lightbox.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
      });
    });

    function closeLightbox() {
      if (lightbox) {
        lightbox.classList.add('hidden');
        document.body.style.overflow = '';
      }
    }

    lightboxClose?.addEventListener('click', closeLightbox);
    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) closeLightbox();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeLightbox();
    });
  </script>
</BaseLayout>
